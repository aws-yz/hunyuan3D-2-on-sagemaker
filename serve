#!/usr/bin/env python3

import json
import logging
import os
import signal
import sys
import tempfile

from flask import Flask, request, jsonify
from inference import model_handler

# 配置日志
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__)

@app.route('/ping', methods=['GET'])
def ping():
    """SageMaker健康检查端点"""
    return '', 200

@app.route('/invocations', methods=['POST'])
def invocations():
    """SageMaker推理端点"""
    try:
        # 检查模型是否已加载
        if not model_handler.model_loaded:
            return jsonify({
                'error': 'Model not loaded yet, please wait',
                'status': 'loading'
            }), 503
        
        # 获取请求数据
        if request.content_type == 'application/json':
            input_data = request.get_json()
        else:
            return jsonify({'error': 'Content-Type must be application/json'}), 400
        
        # 执行推理
        result = model_handler.predict_fn(input_data, model_handler)
        
        return jsonify(result)
        
    except Exception as e:
        logger.error(f"Error in invocations: {str(e)}")
        return jsonify({
            'error': str(e), 
            'status': 'failed'
        }), 500

def signal_handler(sig, frame):
    """处理SIGTERM和SIGINT信号"""
    logger.info(f'Received signal {sig}, shutting down gracefully...')
    sys.exit(0)

def main():
    """主函数"""
    # 注册信号处理器
    signal.signal(signal.SIGTERM, signal_handler)
    signal.signal(signal.SIGINT, signal_handler)
    
    # 启动模型加载（异步）
    logger.info("Starting model loading in background...")
    import threading
    
    def load_model_async():
        try:
            model_handler.load_models()  # 修正方法名
            logger.info("Model loaded successfully!")
        except Exception as e:
            logger.error(f"Failed to load model: {e}")
    
    # 在后台线程中加载模型
    model_thread = threading.Thread(target=load_model_async)
    model_thread.daemon = True
    model_thread.start()
    
    # 启动Flask服务器
    logger.info("Starting Flask server on port 8080...")
    app.run(
        host='0.0.0.0', 
        port=8080, 
        debug=False,
        threaded=True
    )

if __name__ == '__main__':
    main()